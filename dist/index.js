!function(t,n){"object"==typeof exports&&"object"==typeof module?module.exports=n():"function"==typeof define&&define.amd?define([],n):"object"==typeof exports?exports.library=n():t.library=n()}("undefined"!=typeof self?self:this,function(){return function(t){var n={};function e(i){if(n[i])return n[i].exports;var o=n[i]={i:i,l:!1,exports:{}};return t[i].call(o.exports,o,o.exports,e),o.l=!0,o.exports}return e.m=t,e.c=n,e.d=function(t,n,i){e.o(t,n)||Object.defineProperty(t,n,{configurable:!1,enumerable:!0,get:i})},e.n=function(t){var n=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(n,"a",n),n},e.o=function(t,n){return Object.prototype.hasOwnProperty.call(t,n)},e.p="",e(e.s=4)}([function(t,n,e){const i=e(3);t.exports=function(t,n){if(!t)throw new Error("No session provided");if(!n)throw new Error("User not initialized");const e=this;return e.data={job:null},this.new=function(o,r,s,u){if(!r)throw new Error("No user id provided: "+JSON.stringify(arguments));if(!s)throw new Error("No password provided: "+JSON.stringify(arguments));if(!o)throw new Error("No institution id provided: "+JSON.stringify(arguments));const c={loginId:r=r.trim(),password:s=s.trim(),institution:{id:o}};return(u=u&&u.trim())&&u.length>0&&(c.securityCode=u),new Promise(function(o,r){return t.getToken().then(function(){return t.API.send("users/"+n.data.id+"/connections","POST",c)}).then(function(n){n.id||r(n),new i(t,e).get(n.id).then(function(t){o(t)})}).catch(function(t){r(t)})})},this.get=function(i){if(!i)throw new Error("No connection id provided: "+JSON.stringify(arguments));return new Promise(function(o,r){return t.getToken().then(function(){return t.API.send("users/"+n.data.id+"/connections/"+i,"GET")}).then(function(t){t.id||r(t),e.data=t,o(e)}).catch(function(t){r(t)})})},this.update=function(i,o){if(!i)throw new Error("No password provided for connection update");if(!e.institution.id)throw new Error("No institution id set for connection");const r={password:i,institution:{id:e.data.institution.id}};return o&&o.length>0&&(r.securityCode=o),new Promise(function(i,o){return t.getToken().then(function(){return t.API.send("users/"+n.data.id+"/connections/"+e.data.id,"POST",r)}).then(function(t){t.id||o(t),e.data=t,i(e)}).catch(function(t){o(t)})})},this.delete=function(){return new Promise(function(i,o){return t.getToken().then(function(){return t.API.send("users/"+n.data.id+"/connections/"+e.data.id,"DELETE")}).then(function(){i(null)}).catch(function(t){o(t)})})},this.refresh=function(){return new Promise(function(o,r){return t.getToken().then(function(){return t.API.send("users/"+n.data.id+"/connections/"+e.data.id+"/refresh","POST")}).then(function(n){n.id||r(n),new i(t,e).get(n.id).then(function(t){e.data.job=t,e.data.id=t.getConnectionId(),o(e)})}).catch(function(t){r(t)})})},this.for=function(t,n){if(!t)throw new Error("No connection id provided");return e.data.id=t,n&&(e.data.institution={id:n}),e},this.getJobStatus=function(){if(!e.data.job)throw new Error("Job is not initialized");return e.data.job.refreshJobData()},this.canFetchTransactions=async function(t){if(!e.data.job)throw new Error("Job is not initialized");let n;return"retrieve-accounts"===(n=t?await e.data.job.refreshJobData():e.data.job).getCurrentStep().title||"retrieve-transactions"===n.getCurrentStep().title},this.canFetchAccounts=async function(t){if(!e.data.job)throw new Error("Job is not initialized");let n;return"retrieve-accounts"===(n=t?await e.data.job.refreshJobData():e.data.job).getCurrentStep().title&&"success"===n.getCurrentStep().status},this}},function(t,n){t.exports=require("request")},function(t,n,e){const i=e(0);t.exports=function(t){if(!t)throw new Error("No session provided");const n=this;return this.data={id:null,email:null,mobile:null},this.new=function(e){if(e&&!e.email&&!e.mobile)throw new Error("No email or phone number provided for user");return new Promise(function(i,o){return t.getToken().then(function(){return t.API.send("users","POST",e)}).then(function(t){n.data=t,i(n)}).catch(function(t){o(t)})})},this.get=function(e){if(!e)throw new Error("No id provided for user");return new Promise(function(i,o){return t.getToken().then(function(){return t.API.send("users/"+e,"GET")}).then(function(t){n.data=t,i(n)}).catch(function(t){o(t)})})},this.for=function(t){if(!t)throw new Error("No id provided for user");return n.data.id=t,n},this.update=function(e){if(!n.data.id)throw new Error("User has not been initialized");return new Promise(function(i,o){return t.getToken().then(function(){return t.API.send("users/"+n.data.id,"POST",e)}).then(function(t){t.id||o(t),n.data.id=t.id,n.data.email=t.email,n.data.mobile=t.mobile,i(n)}).catch(function(t){o(t)})})},this.delete=function(){if(!n.data.id)throw new Error("User has not been initialized");return new Promise(function(e,i){return t.getToken().then(function(){return t.API.send("users/"+n.data.id,"DELETE")}).then(function(){e(!0)}).catch(function(t){i(t)})})},this.createConnection=function(e,o,r,s){return new i(t,n).new(e,o,r,s)},this.getAllConnections=function(){return new Promise(function(e,i){return t.getToken().then(function(){return t.API.send("users/"+n.data.id+"/connections","GET")}).then(function(t){t.id||i(t),e(t)}).catch(function(t){i(t)})})},this.refreshConnections=function(){return new Promise(function(e,i){return t.getToken().then(function(){return t.API.send("users/"+n.data.id+"/connections/refresh","POST")}).then(function(t){t.data||i("Invalid API response: "+JSON.stringify(t)),e(t.data)}).catch(function(t){i(t)})})},this.fetchAccounts=function(e){return new Promise(function(i,o){return t.getToken().then(function(){let r="users/"+n.data.id+"/accounts";e&&(r+="?filter=connection.id.eq('"+e+"')"),t.API.send(r,"GET").then(function(t){i(t)}).catch(function(t){o(t)})})})},this.fetchAccount=function(e){return new Promise(function(i,o){return t.getToken().then(function(){return t.API.send("users/"+n.data.id+"/accounts/"+e,"GET")}).then(function(t){i(t)}).catch(function(t){o(t)})})},this.fetchTransactions=function(e){return new Promise(function(i,o){return t.getToken().then(function(){let r="users/"+n.data.id+"/transactions";e&&(r+="?filter=connection.id.eq('"+e+"')"),t.API.send(r,"GET").then(function(t){i(t)}).catch(function(t){o(t)})})})},this.fetchTransaction=function(e){return new Promise(function(i,o){return t.getToken().then(function(){return t.API.send("users/"+n.data.id+"/transactions/"+e,"GET")}).then(function(t){i(t)}).catch(function(t){o(t)})})},n}},function(t,n,e){e(0);t.exports=function(t,n){const e=this;this.data={id:null,created:null,updated:null,steps:null,links:null},this.connection=n,this.get=function(n){if(!n)throw new Error("No job id provided");return new Promise(function(i,o){return t.getToken().then(function(){return t.API.send("jobs/"+n,"GET")}).then(function(t){e.data=t,i(e)}).catch(function(t){o(t)})})},this.refreshJobData=function(){if(!e.data.id)throw new Error("Job is not initialized");return this.get(e.data.id)},this.getCurrentStep=function(){let t={title:"uninitialized"};for(let n in e.data.steps)e.data.steps.hasOwnProperty(n)&&"success"===e.data.steps[n].status&&(t=e.data.steps[n]);return t},this.getConnectionId=function(){return e.data.links&&e.data.links.source?e.data.links.source.substr(e.data.links.source.lastIndexOf("/")+1):""},this.getConnection=async function(){let t;return t=""===e.getConnectionId()?(await this.get(e.id)).getConnectionId():e.getConnectionId(),n.get(t)},this.waitForCredentials=function(t,i){let o;const r=Date.now();return new Promise(async function(s,u){const c=async function(a){if(Date.now()-r>1e3*i)return u({error:!0,errorMessage:"The operation has timed out"});const d=(o=a>0?await e.refreshJobData():e).data.steps&&o.data.steps[0];if(d.status&&"in-progress"!==d.status&&"pending"!==d.status)return"success"===d.status?s(n.get(e.getConnectionId())):s(null);setTimeout(c.bind(null,++a),t)};setTimeout(c.bind(null,0),0)})}}},function(t,n,e){t.exports={BasiqSession:e(5),BasiqUser:e(2),BasiqConnection:e(0),BasiqJob:e(3)}},function(t,n,e){const i=e(6),o=e(2),r=function(t){if(!this)return new r(t);let n=null;const e=this;return this.sessionTimestamp=null,this.API=new i("https://au-api.basiq.io").setHeader("Authorization","Basic "+t).setHeader("basiq-version","1.0"),this.expired=function(){return Date.now()-e.sessionTimestamp>36e5},this.getToken=function(){return e.expired()?new Promise(function(i,o){return e.API.setHeader("Authorization","Basic "+t).send("oauth2/token","POST",{grant_type:"client_credentials"}).then(function(t){e.sessionTimestamp=Date.now(),n=t.access_token,e.API.setHeader("Authorization","Bearer "+t.access_token),i(!0)}).catch(function(t){o(t)})}):new Promise(function(t){t(!0)})},this.createUser=function(t){return new o(e).new(t)},this.getUser=function(t){return new o(e).get(t)},this.forUser=function(t){return new o(e).for(t)},this.getInstitutons=function(){return new Promise(function(t,n){return e.getToken().then(function(){return e.API.send("institutions","GET")}).then(function(n){t(n)}).catch(function(t){n(t)})})},this.getInstituton=function(t){return new Promise(function(n,i){return e.getToken().then(function(){return e.API.send("institutions/"+t,"GET")}).then(function(t){n(t)}).catch(function(t){i(t)})})},new Promise(function(t,n){e.getToken().then(function(){t(e)}).catch(function(t){n(t)})})};t.exports=r},function(t,n,e){const i=e(1),o=e(7);e(1).debug=!0;const r=function(t){return this.options={host:t,headers:{"Content-Type":"application/json"}},this};r.prototype.setHeader=function(t,n){return this.options.headers[t]=n,this},r.prototype.send=function(t,n,e){const r={};return r.uri=this.options.host+"/"+t,r.method=n.toUpperCase(),r.headers=function(t){if(null===t||"object"!=typeof t)return t;const n=t.constructor();for(let e in t)t.hasOwnProperty(e)&&(n[e]=t[e]);return n}(this.options.headers),e&&(r.body=JSON.stringify(e),r.headers["Content-Length"]=r.body.length),new Promise(function(t,n){i(r,function(e,i,r){if(e||i.statusCode>299)return n(e||new o(r,i.statusCode));t(JSON.parse(r))})})},t.exports=r},function(t,n){t.exports=function t(n,e){if(void 0===this)return new t(n,e);if("object"==typeof n)return n;let i;try{i=JSON.parse(n)}catch(t){return t}this.statusCode=e,this.response=i,this.message=i.data.reduce(function(t,n){return t+(n.detail+" ")},"").trim()}}])});